<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å‹•æ…‹ç‰ˆ)</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .searchButton { flex: 1; padding: 15px; font-size: 16px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .searchButton:disabled { background-color: #aaa; cursor: not-allowed; }
        #searchPolice { background-color: #007bff; }
        #searchStore { background-color: #28a745; }
        #status { text-align: center; margin: 20px 0; font-style: italic; color: #6c757d; }
        #results li { list-style-type: none; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #results li:last-child { border-bottom: none; }
        #results .info { margin-right: 10px; }
        #results a { display: inline-block; padding: 8px 12px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 5px; white-space: nowrap; }
        #results { padding: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å‹•æ…‹ç‰ˆ)</h2>
        <div class="button-group">
            <button id="searchPolice" class="searchButton">æ‰¾æœ€è¿‘çš„è­¦å¯Ÿå±€</button>
            <button id="searchStore" class="searchButton">æ‰¾æœ€è¿‘çš„ä¾¿åˆ©å•†åº—</button>
        </div>
        <div id="status">è«‹é¸æ“‡è¦æœå°‹çš„é …ç›®ã€‚</div>
        <ul id="results"></ul>
    </div>

    <script>
        // âœ… è«‹ç¢ºä¿é€™è£¡æ˜¯æ­£ç¢º ngrok HTTPS ç¶²å€ (ä¸å¸¶æ–œç·š)
        const BACKEND_API_BASE_URL = "https://jayceon-lawlike-unallegedly.ngrok-free.dev";

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(lat1 * Math.PI / 180) *
                      Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function findNearby(dataType) {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const policeButton = document.getElementById('searchPolice');
            const storeButton = document.getElementById('searchStore');

            policeButton.disabled = true;
            storeButton.disabled = true;
            statusDiv.textContent = 'æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...';
            resultsDiv.innerHTML = '';

            if (!navigator.geolocation) {
                statusDiv.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚';
                policeButton.disabled = false;
                storeButton.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    try {
                        statusDiv.textContent = 'å®šä½æˆåŠŸï¼Œæ­£åœ¨å‘å¾Œç«¯è«‹æ±‚è³‡æ–™...';

                        const params = new URLSearchParams({
                            lat: userLat,
                            lng: userLng,
                            type: dataType
                        });

                        if (!BACKEND_API_BASE_URL) throw new Error("å¾Œç«¯ API ä½å€å°šæœªè¨­å®š");

                        const apiUrl = `${BACKEND_API_BASE_URL}/api/nearby?${params.toString()}`;
                        console.log("âœ… æœ€çµ‚ API URL:", apiUrl);

                        // âœ… ä¿®æ­£é€™è£¡ï¼šç›´æ¥ç”¨ fetchï¼Œä¸å†ç”¨ new URL()
                        const response = await fetch(apiUrl);

                        if (!response.ok) {
                            let errorData = { message: `å¾Œç«¯ä¼ºæœå™¨éŒ¯èª¤ (HTTP ${response.status})` };
                            try { errorData = await response.json(); } catch {}
                            throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
                        }

                        const nearestPlaces = await response.json();
                        console.log("ğŸ“¦ æ”¶åˆ°å¾Œç«¯å›æ‡‰:", nearestPlaces);

                        if (nearestPlaces && nearestPlaces.length > 0) {
                            statusDiv.textContent = `æœå°‹å®Œæˆï¼ä»¥ä¸‹æ˜¯é›¢æ‚¨æœ€è¿‘çš„${dataType === 'police' ? 'è­¦å¯Ÿå±€' : 'ä¾¿åˆ©å•†åº—'}ï¼š`;
                            nearestPlaces.forEach(place => {
                                const li = document.createElement('li');
                                const distanceKm = place.distance;
                                const navLink = `https://www.google.com/maps?q=${place.lat},${place.lng}`;
                                li.innerHTML = `
                                    <div class="info">
                                        <strong>${place.name}</strong><br>
                                        <small>${place.address || ''}</small><br>
                                        <small>è·é›¢æ‚¨ç´„ ${distanceKm} å…¬é‡Œ</small>
                                    </div>
                                    <a href="${navLink}" target="_blank" rel="noopener">å‰å¾€å°èˆª</a>`;
                                resultsDiv.appendChild(li);
                            });
                        } else {
                            statusDiv.textContent = 'åœ¨æ‚¨é™„è¿‘æœªæ‰¾åˆ°ç›¸é—œåœ°é»ã€‚';
                        }
                    } catch (error) {
                        console.error('æŸ¥è©¢éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                        let displayError = 'æŸ¥è©¢æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚';
                        if (error instanceof TypeError && error.message.includes('fetch'))
                            displayError = 'ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹ã€‚';
                        else
                            displayError = `æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;

                        statusDiv.textContent = displayError + `\nğŸ“ æ‚¨çš„ä½ç½®ï¼š${userLat}, ${userLng}`;
                    } finally {
                        policeButton.disabled = false;
                        storeButton.disabled = false;
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMessage = 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚';
                    if (error.code === 1) errorMessage = 'æ‚¨æ‹’çµ•äº†ä½ç½®æˆæ¬Šã€‚è«‹é‡è¨­æ¬Šé™å¾Œå†è©¦ä¸€æ¬¡ã€‚';
                    if (error.code === 2) errorMessage = 'ç„¡æ³•æ ¹æ“šæ‚¨çš„ç¶²è·¯æˆ–GPSåˆ¤æ–·ä½ç½®ã€‚';
                    if (error.code === 3) errorMessage = 'å®šä½è¶…æ™‚ï¼Œè«‹ç¢ºèªæ‚¨çš„ GPSè¨Šè™Ÿè‰¯å¥½ã€‚';
                    statusDiv.textContent = errorMessage;
                    policeButton.disabled = false;
                    storeButton.disabled = false;
                }
            );
        }

        async function main() {
            try {
                await liff.init({ liffId: "2008106671-RMxabbaV" });
                if (liff.isLoggedIn()) {
                    document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
                    document.getElementById('searchStore').addEventListener('click', () => {
                        alert("ä¾¿åˆ©å•†åº—åŠŸèƒ½å°šæœªå®Œæˆï¼Œå¾Œç«¯éœ€æ“´å……ï¼");
                    });
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF Initialization failed', err);
                document.getElementById('status').textContent = 'LIFF åˆå§‹åŒ–å¤±æ•—ã€‚';
            }
        }

        main();
    </script>
</body>
</html>
