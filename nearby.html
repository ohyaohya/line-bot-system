<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å®Œæ•´ç‰ˆ)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: system-ui, -apple-system, sans-serif; margin:0; padding:20px; background:#f4f4f9; color:#333; }
.container { max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
h2 { text-align:center; }
.button-group { display:flex; gap:10px; margin-bottom:20px; }
.searchButton { flex:1; padding:15px; font-size:16px; font-weight:bold; color:white; border:none; border-radius:5px; cursor:pointer; transition:0.2s; }
.searchButton:disabled { background:#aaa; cursor:not-allowed; }
#searchPolice { background:#007bff; }
#searchStore { background:#28a745; }
#status { text-align:center; margin:20px 0; font-style:italic; color:#6c757d; }
#results { padding:0; list-style:none; }
#results li { border-bottom:1px solid #eee; padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
#results li:last-child { border-bottom:none; }
#results a { padding:8px 12px; background:#17a2b8; color:white; text-decoration:none; border-radius:5px; white-space:nowrap; }
#results .info { flex:1; }
</style>
</head>
<body>
<div class="container">
    <h2>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å®Œæ•´ç‰ˆ)</h2>
    <div class="button-group">
        <button id="searchPolice" class="searchButton">æ‰¾æœ€è¿‘çš„è­¦å¯Ÿå±€</button>
        <button id="searchStore" class="searchButton">æ‰¾æœ€è¿‘çš„ä¾¿åˆ©å•†åº—</button>
    </div>
    <div id="status">è«‹é¸æ“‡è¦æœå°‹çš„é …ç›®ã€‚</div>
    <ul id="results"></ul>
</div>

<script>
const BACKEND_API_BASE_URL = "https://jayceon-lawlike-unallegedly.ngrok-free.dev";

async function findNearby(type) {
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const policeBtn = document.getElementById('searchPolice');
    const storeBtn = document.getElementById('searchStore');

    results.innerHTML = '';
    status.textContent = 'æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...';
    policeBtn.disabled = true;
    storeBtn.disabled = true;

    if (!navigator.geolocation) {
        status.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´å®šä½';
        policeBtn.disabled = false;
        storeBtn.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = +pos.coords.latitude.toFixed(6);
        const lng = +pos.coords.longitude.toFixed(6);

        status.textContent = `å®šä½æˆåŠŸï¼š${lat}, ${lng}ï¼Œæ­£åœ¨æŸ¥è©¢...`;

        const params = new URLSearchParams({ lat, lng, type });
        let apiUrl = `${BACKEND_API_BASE_URL}/api/nearby?${params.toString()}`;
        // è½‰ç¢¼ URLï¼Œé¿å…éæ³•å­—å…ƒéŒ¯èª¤
        apiUrl = encodeURI(apiUrl);
        console.log('æœ€çµ‚ API URL:', apiUrl);

        try {
            const resp = await fetch(apiUrl);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            console.log('å›å‚³è³‡æ–™:', data);

            if (!data || data.length === 0) {
                status.textContent = 'é™„è¿‘æ²’æœ‰è³‡æ–™';
            } else {
                data.sort((a,b) => a.distance - b.distance);
                status.textContent = `æ‰¾åˆ° ${data.length} å€‹çµæœï¼Œè·é›¢ç”±è¿‘åˆ°é æ’åº`;
                data.forEach(p => {
                    const li = document.createElement('li');
                    li.innerHTML = `<div class="info"><strong>${p.name}</strong><br>${p.address || ''}<br>è·é›¢ç´„ ${p.distance} å…¬é‡Œ</div>
                                    <a href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank">å°èˆª</a>`;
                    results.appendChild(li);
                });
            }
        } catch (err) {
            console.error(err);
            status.textContent = `æŸ¥è©¢å¤±æ•—ï¼š${err.message}\nğŸ“ ç¶“ç·¯åº¦ï¼š${lat},${lng}`;
        } finally {
            policeBtn.disabled = false;
            storeBtn.disabled = false;
        }

    }, (err) => {
        console.error(err);
        let msg = 'ç„¡æ³•å–å¾—ä½ç½®';
        if (err.code === 1) msg = 'æ‚¨æ‹’çµ•äº†ä½ç½®æˆæ¬Š';
        if (err.code === 2) msg = 'ç„¡æ³•æ ¹æ“šç¶²è·¯/GPSåˆ¤æ–·ä½ç½®';
        if (err.code === 3) msg = 'å®šä½è¶…æ™‚ï¼Œè«‹ç¢ºèª GPSè¨Šè™Ÿ';
        status.textContent = msg;
        policeBtn.disabled = false;
        storeBtn.disabled = false;
    });
}

// LIFF åˆå§‹åŒ–
async function main() {
    try {
        await liff.init({ liffId: "2008106671-RMxabbaV" });
        if (liff.isLoggedIn()) {
            document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
            document.getElementById('searchStore').addEventListener('click', () => findNearby('store'));
        }
    } catch (err) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
        document.getElementById('status').textContent = 'LIFF åˆå§‹åŒ–å¤±æ•—';
    }
}

main();
</script>
</body>
</html>
