<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å„ªåŒ–ç‰ˆ)</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- ğŸ¨ æ¨£å¼ç¨å¾®ç¾åŒ– --- */
        body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;margin:0;padding:20px;background:#f4f4f9;color:#333} 
        .container{max-width:760px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08)} 
        h2{text-align:center;margin:0 0 14px; color: #111827;} 
        .controls{display:flex;flex-direction:column;gap:10px;margin-bottom:14px} 
        .row{display:flex;gap:8px;flex-wrap:wrap} 
        select,.btn{padding:12px;border:1px solid #d1d5db;border-radius:10px;font-size:15px; background-color: #fff;} 
        select{flex:1; cursor: pointer;} 
        .btn{cursor:pointer;font-weight:700; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;}
        .btn:hover:not(:disabled) { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-1px);}
        .btn-primary{background:#0d6efd;color:#fff;border:none} 
        .btn-primary:hover:not(:disabled){background:#0b5ed7;}
        .btn-success{background:#198754;color:#fff;border:none} 
        .btn-success:hover:not(:disabled){background:#157347;}
        .btn-ghost{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;}
        .btn-ghost:hover:not(:disabled){background:#e5e7eb;}
        .btn-toggle{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;}
        .btn-toggle.active{background:#1f2937;color:#fff;border-color:#1f2937;}
        .btn:disabled{opacity:.6;cursor:not-allowed} 
        #status{margin:10px 0 6px;text-align:center;color:#6b7280;font-style:italic; min-height: 1.2em;} 
        #coords{font-size:12px;color:#9aa0a6;text-align:center;margin-top:-2px;margin-bottom:10px} 
        .my-location{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border:1px dashed #d1d5db;border-radius:10px;background:#fafafa;margin:8px 0 14px} 
        .myloc-info{flex:1} 
        .map-thumb{width:110px;height:110px;border-radius:8px;object-fit:cover;border:1px solid #e5e7eb} 
        .card{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:10px;transition:transform .1s,background .2s} 
        .card:hover{background:#f9fafb;transform:translateY(-1px)} 
        .nav-btn{display:inline-block;margin-top:6px;padding:6px 10px;background:#17a2b8;color:#fff;text-decoration:none;border-radius:8px;font-size:13px; transition: background-color 0.2s;}
        .nav-btn:hover { background-color: #117a8b;}
        .mode-switch{display:flex;gap:8px;justify-content:flex-end;margin:8px 0} 
        .loading{display:inline-block; width: 1.2em; height: 1.2em; border: 3px solid rgba(13, 110, 253, 0.3); border-radius: 50%; border-top-color: #0d6efd; animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle;}
        @keyframes spin { to { transform: rotate(360deg); } } 
        #mapWrap{display:none;height:420px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden; margin-top: 10px;} 
        #map{width:100%;height:100%} 
        ul{list-style:none;margin:0;padding:0}
    </style>
</head>
<body>
    <div class="container">
        <h2>æŸ¥æ‰¾é™„è¿‘è¨­æ–½ (å„ªåŒ–ç‰ˆ)</h2>
        <div class="controls">
            <div class="row">
                <select id="radiusSelect" title="é¸æ“‡æœå°‹åŠå¾‘">
                    <option value="2">2 å…¬é‡Œå…§</option>
                    <option value="5" selected>5 å…¬é‡Œå…§</option>
                    <option value="10">10 å…¬é‡Œå…§</option>
                    <option value="9999">ä¸é™è·é›¢</option>
                </select>
                <button id="searchPolice" class="btn btn-primary" style="flex:1" disabled>æ‰¾æœ€è¿‘çš„è­¦å¯Ÿå±€</button>
                <button id="searchStore"  class="btn btn-success" style="flex:1" disabled>æ‰¾æœ€è¿‘çš„ä¾¿åˆ©å•†åº—</button>
            </div>
            <div class="mode-switch">
                <button id="toggleList" class="btn btn-toggle active" disabled>æ¸…å–®æ¨¡å¼</button>
                <button id="toggleMap"  class="btn btn-toggle" disabled>åœ°åœ–æ¨¡å¼</button>
            </div>
        </div>

        <div id="myLoc" class="my-location" style="display:none;">
            <div class="myloc-info">
                <div style="font-weight:700">æˆ‘çš„ä½ç½®</div>
                <div id="mylocAdmin" style="color:#4b5563">å®šä½ä¸­â€¦</div>
                <div id="coords"></div>
                <button id="relocate" class="btn btn-ghost" disabled>é‡æ–°å®šä½</button>
            </div>
            <img id="myLocMap" class="map-thumb" alt="æˆ‘çš„ä½ç½®åœ°åœ–" />
        </div>

        <div id="status">æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨...</div>
        <div id="count" style="font-size:13px;color:#6b7280;text-align:center;margin-bottom:8px"></div>
        <div id="mapWrap"><div id="map"></div></div>
        <ul id="results"></ul>
    </div>

    <script>
        // --- è¨­å®š ---
        // ã€ã€ã€é—œéµï¼ï¼ï¼ã€‘ã€‘ã€‘ è«‹å‹™å¿…å°‡æ­¤è™•æ›æˆæ‚¨ ngrok æˆ– Render çš„å…¬é–‹ HTTPS ç¶²å€
        const BACKEND_API_BASE_URL = "ã€è«‹å¡«å…¥æ‚¨ ngrok æˆ– Render çš„å…¬é–‹ HTTPS ç¶²å€ã€‘"; 
        // ã€ã€ã€é—œéµï¼ï¼ï¼ã€‘ã€‘ã€‘ è«‹å‹™å¿…å°‡æ­¤è™•æ›æˆæŒ‡å‘æ­¤ nearby.html çš„ LIFF ID
        const LIFF_ID = "ã€è«‹è²¼ä¸ŠæŸ¥æ‰¾è¨­æ–½çš„LIFF_IDã€‘"; 

        // --- å…¨åŸŸè®Šæ•¸ ---
        let GOOGLE_KEY = "";
        let CURRENT_POS = null; // {lat: number, lng: number} | null
        let MAP, MARKERS = [], MAP_LOADED = false, MAP_INSTANCE_CREATED = false;
        let CURRENT_RESULTS = []; // å„²å­˜ç›®å‰çš„æœå°‹çµæœ
        let CURRENT_MODE = "list"; // 'list' æˆ– 'map'

        // --- DOM å…ƒç´ å¿«å– (æé«˜æ•ˆèƒ½) ---
        const statusDiv = document.getElementById("status");
        const countDiv = document.getElementById("count");
        const resultsUl = document.getElementById("results");
        const mapWrapDiv = document.getElementById("mapWrap");
        const myLocDiv = document.getElementById("myLoc");
        const mylocAdminDiv = document.getElementById("mylocAdmin");
        const coordsDiv = document.getElementById("coords");
        const myLocMapImg = document.getElementById("myLocMap");
        const radiusSelect = document.getElementById("radiusSelect");
        const searchPoliceBtn = document.getElementById("searchPolice");
        const searchStoreBtn = document.getElementById("searchStore");
        const toggleListBtn = document.getElementById("toggleList");
        const toggleMapBtn = document.getElementById("toggleMap");
        const relocateBtn = document.getElementById("relocate");

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        async function fetchKey(){
            try { 
                // ç¢ºä¿å¾Œç«¯ç¶²å€å·²è¨­å®š
                if (!BACKEND_API_BASE_URL || BACKEND_API_BASE_URL.startsWith("ã€è«‹å¡«å…¥")) {
                     throw new Error("å¾Œç«¯ API ä½å€å°šæœªæ­£ç¢ºè¨­å®šæ–¼å‰ç«¯ç¨‹å¼ç¢¼ä¸­");
                }
                const r = await fetch(`${BACKEND_API_BASE_URL}/api/config`); 
                if (!r.ok) throw new Error(`ç„¡æ³•é€£æ¥å¾Œç«¯è¨­å®š API (HTTP ${r.status})`); 
                const data = await r.json();
                GOOGLE_KEY = data.GOOGLE_MAPS_API_KEY || ""; 
                // ç§»é™¤éæ³•å­—å…ƒæˆ–ç©ºå­—ä¸²ï¼Œç¢ºä¿é‡‘é‘°æœ‰æ•ˆ
                // ä¿®æ­£: å…è¨±ç©ºå­—ä¸²ï¼Œä½†åœ¨éœ€è¦é‡‘é‘°çš„åœ°æ–¹æª¢æŸ¥
                if (typeof GOOGLE_KEY !== 'string' ) { // || !/^[a-zA-Z0-9_-]*$/.test(GOOGLE_KEY)) { 
                     GOOGLE_KEY = "";
                     console.warn("å¾Œç«¯æä¾›çš„ Google API Key æ ¼å¼ç„¡æ•ˆã€‚");
                }
                if (!GOOGLE_KEY) console.warn("å¾Œç«¯æœªæä¾› Google API Keyï¼Œåœ°åœ–ç›¸é—œåŠŸèƒ½å¯èƒ½å—é™ã€‚");
                else console.log("âœ… Google Key OK"); 
            } catch (err) { 
                console.error("âŒ fetchKey fail:", err); 
                statusDiv.textContent = `âŒ ç„¡æ³•å–å¾—å¾Œç«¯è¨­å®š: ${err.message}`; 
                disableAllButtons(true); 
                throw err; // æ‹‹å‡ºéŒ¯èª¤ï¼Œä¸­æ–·å¾ŒçºŒåˆå§‹åŒ–
            }
        }

        function staticMap(lat,lng,pin="red",size="150x150",zoom=16){
             if (!GOOGLE_KEY) return "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // è¿”å›é€æ˜åƒç´ 
             // ç¢ºä¿ lat, lng æ˜¯æ•¸å­—
             lat = parseFloat(lat); lng = parseFloat(lng);
             if (isNaN(lat) || isNaN(lng)) return "";
             return `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=${zoom}&size=${size}&maptype=roadmap&markers=color:${pin}%7C${lat},${lng}&key=${GOOGLE_KEY}`;
        }

        function loadGoogleMapsJS(){
            if (MAP_LOADED || !GOOGLE_KEY) return Promise.resolve(); 
            return new Promise((resolve,reject)=>{ 
                console.log("â³ Loading Google Maps JS..."); 
                const s = document.createElement("script"); 
                s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_KEY}&libraries=marker&language=zh-TW`; 
                s.async = true; s.defer = true; 
                s.onload = ()=>{ MAP_LOADED = true; console.log("âœ… Google Maps JS OK"); resolve(); }; 
                s.onerror = (err)=>{ console.error("âŒ Google Maps JS fail:", err); statusDiv.textContent = "âŒ ç„¡æ³•è¼‰å…¥åœ°åœ–å…ƒä»¶"; reject(err); }; 
                document.head.appendChild(s); 
            });
        }

        function getGeolocation(forceRefresh = false){
             return new Promise((resolve,reject)=>{ 
                if (CURRENT_POS && !forceRefresh) { console.log("â„¹ï¸ Using cached location"); return resolve(CURRENT_POS); } 
                if (!navigator.geolocation) return reject(new Error("æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½")); 
                statusDiv.innerHTML = '<span class="loading"></span>ğŸ“ æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®â€¦ (è«‹å…è¨±æˆæ¬Š)'; 
                navigator.geolocation.getCurrentPosition( 
                    pos => { CURRENT_POS = {lat:pos.coords.latitude,lng:pos.coords.longitude}; console.log("âœ… Geolocation OK:", CURRENT_POS); resolve(CURRENT_POS); }, 
                    err => { console.error("âŒ Geolocation fail:", err); const m = {1:"æ‚¨æ‹’çµ•äº†å®šä½æˆæ¬Š",2:"ç„¡æ³•æ ¹æ“šç¶²è·¯æˆ–GPSåˆ¤æ–·ä½ç½®",3:"å®šä½è¶…æ™‚"}; reject(new Error(m[err.code]||"å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªæ‰‹æ©Ÿè¨­å®š")); }, 
                    {enableHighAccuracy:true,timeout:15000,maximumAge:0} 
                ); 
            });
        }

        async function reverseGeocode(lat,lng){
            // é¿å…åœ¨æ²’æœ‰ Key çš„æƒ…æ³ä¸‹å‘¼å«
            if (!GOOGLE_KEY) return "åœ°å€æœå‹™æœªå°±ç·’"; 
            // å„ªåŒ–: åªæœ‰åœ¨éœ€è¦æ›´æ–°æ™‚æ‰å‘¼å«
            if (mylocAdminDiv.textContent && !mylocAdminDiv.textContent.includes("â€¦")) return mylocAdminDiv.textContent; 
            
            try{ 
                const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=zh-TW&result_type=administrative_area_level_1|administrative_area_level_2|administrative_area_level_3|locality|sublocality_level_1|route|neighborhood&key=${GOOGLE_KEY}`; 
                const r = await fetch(url); 
                if (!r.ok) throw new Error("Geocode HTTP "+r.status); 
                const j = await r.json(); 
                if(j.status!=="OK" || !j.results?.length) return "åœ°å€ä¸è©³"; 
                const comps = j.results[0].address_components; 
                const g = t => comps.find(c=>c.types.includes(t))?.long_name || ""; 
                const route = g("route"); const neighborhood = g("neighborhood"); const sublocality = g("sublocality_level_1") || g("administrative_area_level_3") || g("locality"); const city = g("administrative_area_level_1") || g("administrative_area_level_2"); 
                let formattedAddress = city; if (sublocality && sublocality !== city) formattedAddress += ` ${sublocality}`; if (neighborhood) formattedAddress += ` ${neighborhood}`; 
                // æ”¹ç‚ºé¡¯ç¤ºè·¯åï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºå€åŸŸ
                if (route) formattedAddress += ` ${route} é™„è¿‘`; 
                else if (neighborhood) {} // å·²åŠ å…¥
                else if (sublocality) {} // å·²åŠ å…¥
                
                return formattedAddress || j.results[0].formatted_address || "åœ°å€ä¸è©³"; 
            } catch (err) { console.error("âŒ Reverse Geocode fail:", err); return "ç„¡æ³•å–å¾—åœ°å€è³‡è¨Š"; }
        }

        async function renderMyLocation(pos){
            myLocDiv.style.display="flex"; 
            coordsDiv.textContent = `(${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)})`; 
            const staticMapUrl = staticMap(pos.lat,pos.lng,"blue","220x220",15);
            myLocMapImg.src = staticMapUrl; // ç›´æ¥è¨­å®šï¼Œè‹¥ staticMapUrl ç‚ºç©ºå‰‡ä¸é¡¯ç¤º
            if (!staticMapUrl) myLocMapImg.alt = "åœ°åœ–é è¦½ (éœ€ API Key)"; // æä¾›æ›¿ä»£æ–‡å­—
            mylocAdminDiv.textContent = "æ­£åœ¨è§£æåœ°å€â€¦"; 
            const txt = await reverseGeocode(pos.lat,pos.lng); 
            mylocAdminDiv.textContent = txt;
        }

        function renderList(results){
            resultsUl.innerHTML = ""; mapWrapDiv.style.display = "none"; 
            if (!results || !results.length) return; 
            results.forEach(p=>{ 
                const li = document.createElement("li"); li.className="card"; 
                const mapUrl = staticMap(p.lat,p.lng,"red","180x120",16); 
                // ã€ã€ã€å·²ä¿®æ­£ $ ç¬¦è™Ÿã€‘ã€‘ã€‘
                const navLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`; 
                li.innerHTML = `<div class="info" style="flex:1"><strong>${p.name}</strong><br><small style="color:#4b5563">${p.address}</small><br><small style="color:#6b7280">è·é›¢æ‚¨ç´„ ${p.distance.toFixed(2)} å…¬é‡Œ</small><br><a class="nav-btn" href="${navLink}" target="_blank" rel="noopener">å‰å¾€å°èˆª</a></div>${mapUrl ? `<img class="map-thumb" src="${mapUrl}" alt="åœ°åœ–é è¦½" loading="lazy">` : ''}`; 
                resultsUl.appendChild(li); 
            }); 
            CURRENT_MODE = "list"; updateToggleButtons();
        }

        async function renderMap(results){
            resultsUl.innerHTML = ""; 
            try { await loadGoogleMapsJS(); } catch (err) { statusDiv.textContent = "âŒ ç„¡æ³•è¼‰å…¥åœ°åœ–å…ƒä»¶"; return; } 
            mapWrapDiv.style.display = "block"; 
            if (!MAP_INSTANCE_CREATED){ 
                try {
                    MAP = new google.maps.Map(document.getElementById("map"), { center: CURRENT_POS || {lat:25.0479,lng:121.5170}, zoom: 13, mapTypeControl:false, streetViewControl: false }); 
                    MAP_INSTANCE_CREATED = true; 
                    console.log("âœ… Google Map instance created");
                } catch (mapErr) {
                     console.error("âŒ ç„¡æ³•å»ºç«‹ Google Map å¯¦ä¾‹:", mapErr);
                     statusDiv.textContent = "âŒ ç„¡æ³•å»ºç«‹åœ°åœ–ï¼Œè«‹ç¢ºèª Google API Key æ˜¯å¦æœ‰æ•ˆã€‚";
                     mapWrapDiv.style.display = "none"; // éš±è—åœ°åœ–å€åŸŸ
                     return; // ä¸­æ–·åŸ·è¡Œ
                }
            } 
            MARKERS.forEach(m=>m.setMap(null)); MARKERS = []; 
            const bounds = new google.maps.LatLngBounds(); 
            results.forEach(p=>{ 
                const marker = new google.maps.Marker({position:{lat:p.lat,lng:p.lng}, map:MAP, title:p.name}); 
                const infowindow = new google.maps.InfoWindow(); 
                marker.addListener('click', () => { 
                    // ã€ã€ã€å·²ä¿®æ­£ $ ç¬¦è™Ÿã€‘ã€‘ã€‘
                    const navLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`; 
                    const content = `<strong>${p.name}</strong><br>${p.address}<br><small>è·é›¢ç´„ ${p.distance.toFixed(2)} km</small><br><br><a href="${navLink}" target="_blank" rel="noopener">å°èˆªåˆ°é€™è£¡</a>`; 
                    infowindow.setContent(content); infowindow.open(MAP, marker); 
                }); 
                MARKERS.push(marker); bounds.extend(marker.getPosition()); 
            }); 
            if (CURRENT_POS){ 
                const you = new google.maps.Marker({ position: CURRENT_POS, map: MAP, title: "æˆ‘çš„ä½ç½®", icon: {path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:"#2563eb", fillOpacity:1, strokeWeight:2, strokeColor:"#fff"} }); 
                MARKERS.push(you); bounds.extend(you.getPosition()); 
            } 
            if (results.length > 0 || CURRENT_POS) { 
                 // å»¶é² fitBounds ç¢ºä¿åœ°åœ–å·²æ¸²æŸ“
                 setTimeout(() => {
                      if (MAP && bounds && !bounds.isEmpty()) {
                          MAP.fitBounds(bounds); 
                          google.maps.event.addListenerOnce(MAP, 'idle', function() { 
                              let currentZoom = MAP.getZoom();
                              // é™åˆ¶æœ€å¤§å’Œæœ€å°ç¸®æ”¾ç´šåˆ¥
                              const maxZoom = 17; 
                              const minZoom = 3;
                              if (currentZoom > maxZoom) MAP.setZoom(maxZoom);
                              else if (currentZoom < minZoom) MAP.setZoom(minZoom);
                              
                              // å–®é»å„ªåŒ–
                              if (results.length === 1 && CURRENT_POS && MAP.getZoom() > 16) MAP.setZoom(16); 
                              else if (results.length === 0 && CURRENT_POS && MAP.getZoom() < 15) MAP.setZoom(15); 
                          }); 
                      } else {
                           console.warn("Bounds are empty or Map not ready for fitBounds");
                      }
                 }, 100); // å»¶é² 100ms

            } 
            CURRENT_MODE = "map"; updateToggleButtons();
        }

        async function findNearby(type, forceRefreshLocation = false){
            disableAllButtons(true); resultsUl.innerHTML=""; mapWrapDiv.style.display="none"; countDiv.textContent = ""; 
            try{ 
                const pos = await getGeolocation(forceRefreshLocation); 
                await renderMyLocation(pos.lat,pos.lng); 
                statusDiv.innerHTML = '<span class="loading"></span>ğŸ” æ­£åœ¨å¾å¾Œç«¯æœå°‹é™„è¿‘åœ°é»â€¦'; 
                const radius = parseFloat(radiusSelect.value); 
                const params = new URLSearchParams({ lat: pos.lat, lng: pos.lng, type: type, limit: 50 }); 
                if (!BACKEND_API_BASE_URL || BACKEND_API_BASE_URL.startsWith("ã€è«‹å¡«å…¥")) throw new Error("å¾Œç«¯ API ä½å€å°šæœªæ­£ç¢ºè¨­å®š"); 
                const apiUrl = `${BACKEND_API_BASE_URL}/api/nearby?${params.toString()}`; 
                console.log("FETCH:", apiUrl); 
                const r = await fetch(new URL(apiUrl)); 
                if(!r.ok) { let eData={message:`HTTP ${r.status}`}; try{eData=await r.json();}catch{} throw new Error(eData.error || eData.message || `HTTP ${r.status}`); } 
                let data = await r.json(); 
                console.log(`RECV ${data.length} results`); 
                data = data.filter(p=> (radius === 9999) || (p.distance <= radius)); 
                console.log(`FILTERED ${data.length} results`); 
                CURRENT_RESULTS = data; 
                if(!data.length){ statusDiv.textContent = `âš ï¸ ${radius===9999 ? "é™„è¿‘æ²’æœ‰ç¬¦åˆçš„è³‡æ–™" : `${radius} å…¬é‡Œå…§æ²’æœ‰ç¬¦åˆçš„åœ°é»`}`; return; } 
                statusDiv.textContent = `ä»¥ä¸‹æ˜¯ ${radius===9999 ? "æœå°‹åˆ°çš„" : `${radius} å…¬é‡Œå…§`} ${type==="police"?"è­¦å¯Ÿå±€":"ä¾¿åˆ©å•†åº—"}ï¼š`; 
                countDiv.textContent = `å…± ${data.length} ç­†çµæœï¼ˆå·²ä¾è·é›¢æ’åºï¼‰`; 
                if (CURRENT_MODE === "map") { renderMap(data); } 
                else { renderList(data); } 
            } catch(e) { 
                console.error("âŒ FindNearby fail:", e); 
                statusDiv.textContent = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${e.message}`; 
            } finally { 
                 disableAllButtons(false); 
                 toggleListBtn.disabled = !CURRENT_RESULTS.length; 
                 toggleMapBtn.disabled = !CURRENT_RESULTS.length; 
            }
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function disableAllButtons(disabled) {
            searchPoliceBtn.disabled = disabled; searchStoreBtn.disabled = disabled;
            toggleListBtn.disabled = disabled || !CURRENT_RESULTS.length;
            toggleMapBtn.disabled = disabled || !CURRENT_RESULTS.length;
            relocateBtn.disabled = disabled;
        }

        function updateToggleButtons() {
             const isList = CURRENT_MODE === "list";
             toggleListBtn.classList.toggle('active', isList);
             toggleMapBtn.classList.toggle('active', !isList);
        }

        // --- åˆå§‹åŒ–æµç¨‹ ---
        async function initializeApp() {
            disableAllButtons(true); // å…ˆç¦ç”¨
            try {
                statusDiv.textContent = 'æ­£åœ¨å–å¾—å¾Œç«¯è¨­å®š...';
                await fetchKey(); // 1. å–å¾— Key

                // 2. å‹•æ…‹è¼‰å…¥ Google Maps (éåŒæ­¥)
                loadGoogleMapsJS().catch(err => { 
                     console.warn("Google Maps JS å¯èƒ½è¼‰å…¥å¤±æ•—ï¼Œåœ°åœ–æ¨¡å¼å°‡ç„¡æ³•ä½¿ç”¨ã€‚");
                     toggleMapBtn.disabled = true; // ç¦ç”¨ Map æŒ‰éˆ•
                });

                statusDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ– LIFF...';
                // 3. åˆå§‹åŒ– LIFF
                // ã€ã€ã€é—œéµï¼ï¼ï¼ã€‘ã€‘ã€‘ ç¢ºä¿ LIFF_ID å·²æ­£ç¢ºå¡«å¯«ï¼
                if (!LIFF_ID || LIFF_ID.startsWith("ã€è«‹è²¼ä¸Š")) throw new Error("LIFF ID å°šæœªæ­£ç¢ºè¨­å®šæ–¼å‰ç«¯ç¨‹å¼ç¢¼ä¸­");
                await liff.init({ liffId: LIFF_ID }); 
                
                if (liff.isLoggedIn()) {
                    statusDiv.textContent = 'åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å˜—è©¦è‡ªå‹•å®šä½...';
                    // 4. å˜—è©¦åˆå§‹å®šä½
                    try {
                        const initialPos = await getGeolocation();
                        await renderMyLocation(initialPos);
                        statusDiv.textContent = 'å®šä½å®Œæˆï¼Œè«‹é¸æ“‡è¦æœå°‹çš„é …ç›®ã€‚';
                    } catch (locErr) {
                         statusDiv.textContent = `âš ï¸ ç„¡æ³•è‡ªå‹•å®šä½ï¼š${locErr.message} è«‹æ‰‹å‹•é»æ“Šæœå°‹æŒ‰éˆ•ã€‚`;
                    }
                    
                    // 5. å•Ÿç”¨æŒ‰éˆ•
                    searchPoliceBtn.disabled = false;
                    searchStoreBtn.disabled = false; // ä¾¿åˆ©å•†åº—æŒ‰éˆ•ä¹Ÿå•Ÿç”¨
                    relocateBtn.disabled = false;
                    toggleListBtn.disabled = true; // åˆå§‹ç¦ç”¨åˆ‡æ›
                    toggleMapBtn.disabled = true;
                    updateToggleButtons(); // æ›´æ–°æ¨£å¼

                    // 6. ç¶å®šäº‹ä»¶
                    searchPoliceBtn.addEventListener("click", ()=> findNearby("police"));
                    // ã€å•Ÿç”¨ã€‘ä¾¿åˆ©å•†åº—æŒ‰éˆ•å¯¦éš›å‘¼å« type=store
                    searchStoreBtn.addEventListener("click", ()=> findNearby("store"));                     
                    
                    toggleMapBtn.addEventListener("click", ()=> { if (!CURRENT_RESULTS.length || CURRENT_MODE === "map") return; renderMap(CURRENT_RESULTS); });
                    toggleListBtn.addEventListener("click", ()=> { if (!CURRENT_RESULTS.length || CURRENT_MODE === "list") return; renderList(CURRENT_RESULTS); });
                    // ã€å„ªåŒ–ã€‘é‡æ–°å®šä½å¾Œï¼Œæœå°‹ä¸Šæ¬¡é¸å®šçš„é¡å‹
                    relocateBtn.addEventListener("click", ()=> {
                        // åˆ¤æ–·ä¸Šæ¬¡æœå°‹é¡å‹ï¼Œè‹¥ç„¡å‰‡é è¨­ police
                        const lastSearchType = CURRENT_RESULTS.length > 0 ? (CURRENT_RESULTS[0].brand === 'è­¦å¯Ÿå±€' ? 'police' : 'store') : 'police';
                        findNearby(lastSearchType, true); // å¼·åˆ¶åˆ·æ–°ä½ç½®ä¸¦æœå°‹
                    });

                } else { // æœªç™»å…¥
                     statusDiv.textContent = 'è«‹å…ˆç™»å…¥ LINE ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚';
                     disableAllButtons(true); 
                     // ã€å„ªåŒ–ã€‘ç™»å…¥å¾Œé‡æ–°å°å‘å›åŒä¸€é é¢
                     liff.login({ redirectUri: location.href }); 
                }
            } catch (err) { // è™•ç† fetchKey æˆ– liff.init çš„å¤±æ•—
                console.error('âŒ æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—:', err);
                statusDiv.textContent = `âŒ æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ï¼š${err.message}`;
                disableAllButtons(true); 
            }
        }
        
        // åŸ·è¡Œåˆå§‹åŒ–
        initializeApp();
        
    </script>
    </body>
</html>
