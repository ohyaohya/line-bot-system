<script>
    async function findNearby(dataType) {
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const policeButton = document.getElementById('searchPolice');
        const storeButton = document.getElementById('searchStore');

        policeButton.disabled = true;
        storeButton.disabled = true;
        statusDiv.textContent = '正在取得您的位置...';
        resultsDiv.innerHTML = '';

        let userLat, userLng;

        try {
            if (liff.isInClient()) {
                // 在 LINE 裡試著用 LIFF API
                const loc = await liff.getLocation();
                if (loc) {
                    userLat = loc.latitude;
                    userLng = loc.longitude;
                }
            }
        } catch (e) {
            console.warn("liff.getLocation 失敗，改用 navigator.geolocation");
        }

        if (!userLat || !userLng) {
            // fallback 到瀏覽器 Geolocation
            if (!navigator.geolocation) {
                statusDiv.textContent = '您的瀏覽器不支援定位功能。';
                policeButton.disabled = false;
                storeButton.disabled = false;
                return;
            }

            await new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        resolve();
                    },
                    (err) => {
                        console.error("Geolocation error:", err);
                        statusDiv.textContent = "無法取得您的位置，請檢查權限或網路。";
                        policeButton.disabled = false;
                        storeButton.disabled = false;
                        resolve();
                    }
                );
            });
        }

        if (!userLat || !userLng) return;

        // 後續計算距離 & 顯示結果（保留你的原程式）
        statusDiv.textContent = '計算距離中...';
        let targetLocations = (dataType === 'police') ? policeStations : convenienceStores;
        const locationsWithDistance = targetLocations.map(place => {
            const distance = getDistance(userLat, userLng, place.lat, place.lng);
            return { ...place, distance };
        });
        locationsWithDistance.sort((a, b) => a.distance - b.distance);

        statusDiv.textContent = `搜尋完成！以下是離您最近的${dataType === 'police' ? '警察局' : '便利商店'}：`;
        locationsWithDistance.forEach(place => {
            const li = document.createElement('li');
            const distanceKm = place.distance.toFixed(2);
            const navLink = `https://www.google.com/maps?q=${place.lat},${place.lng}`;
            li.innerHTML = `<div><strong>${place.name}</strong><br><small>距離您約 ${distanceKm} 公里</small></div><a href="${navLink}" target="_blank" rel="noopener">前往導航</a>`;
            resultsDiv.appendChild(li);
        });

        policeButton.disabled = false;
        storeButton.disabled = false;
    }

    async function main() {
        try {
            await liff.init({ liffId: "2008106671-RMxabbaV" });

            // 不論是否登入，都先綁定按鈕
            document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
            document.getElementById('searchStore').addEventListener('click', () => findNearby('store'));

            // 如果在 LINE 裡但沒登入，觸發登入
            if (!liff.isLoggedIn() && liff.isInClient()) {
                liff.login();
            }

        } catch (err) {
            console.error('LIFF 初始化失敗', err);
            document.getElementById('status').textContent = 'LIFF 初始化失敗。';
        }
    }
    main();
</script>
