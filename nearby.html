<script>
    // --- 資料庫區 (台北市地點) ---
    const policeStations = [
        { lat: 25.0448, lng: 121.5147, name: '臺北市政府警察局中正第一分局', address: '100台北市中正區公園路15號' },
        { lat: 25.0335, lng: 121.5430, name: '臺北市政府警察局大安分局', address: '106台北市大安區復興南路二段80號' },
        { lat: 25.0479, lng: 121.5170, name: '臺北市政府警察局中山分局', address: '104台北市中山區中山北路一段1號' }
    ];
    const convenienceStores = [
        { lat: 25.0494, lng: 121.5172, name: '7-ELEVEN 京站門市', address: '103台北市大同區承德路一段1號B2' },
        { lat: 25.0337, lng: 121.5644, name: '全家便利商店 101店', address: '110台北市信義區市府路45號B1' },
        { lat: 25.0441, lng: 121.5222, name: '萊爾富 北市捷運店', address: '100台北市中正區忠孝西路一段49號B1' }
    ];
    
    // 全域變數，讓所有函式都能使用
    let map;
    let infowindow;

    // 【已加回】這是 Google Maps API 載入完成後，會自動呼叫的函式
    function initMap() {
        const mapCenter = { lat: 25.0479, lng: 121.5170 }; // 以台北市中心為預設中心點
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 14,
            center: mapCenter,
        });
        infowindow = new google.maps.InfoWindow();
    }

    // 計算距離的函式
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c;
    }

    // 主要的搜尋功能函式
    async function findNearby(dataType) {
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        statusDiv.textContent = '正在取得您的位置...';
        resultsDiv.innerHTML = '';
        let targetLocations = (dataType === 'police') ? policeStations : convenienceStores;

        try {
            const location = await liff.getLocation();
            const userLat = location.latitude;
            const userLng = location.longitude;
            statusDiv.textContent = '計算距離中...';

            const locationsWithDistance = targetLocations.map(place => {
                const distance = getDistance(userLat, userLng, place.lat, place.lng);
                return { ...place, distance };
            });

            locationsWithDistance.sort((a, b) => a.distance - b.distance);
            
            statusDiv.textContent = `搜尋完成！以下是離您最近的${dataType === 'police' ? '警察局' : '便利商店'}：`;
            locationsWithDistance.forEach(place => {
                const li = document.createElement('li');
                const distanceKm = place.distance.toFixed(2);
                const navLink = `https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}`;
                li.innerHTML = `<strong>${place.name}</strong><br><small>距離您約 ${distanceKm} 公里</small><a href="${navLink}" target="_blank" rel="noopener">前往導航</a>`;
                resultsDiv.appendChild(li);
            });

        } catch (error) {
            console.error(error);
            statusDiv.textContent = '無法取得您的位置。請確認您已授權 LINE 分享位置資訊。';
        }
    }

    // LIFF 初始化函式
    async function main() {
        try {
            await liff.init({ liffId: "2008106671-RMxabbaV" });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
                document.getElementById('searchStore').addEventListener('click', () => findNearby('store'));
            }
        } catch (err) {
            console.error('LIFF Initialization failed', err);
            document.getElementById('status').textContent = 'LIFF 初始化失敗，請確認 LIFF ID 是否正確。';
        }
    }
    main();
</script>

