<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>查找附近設施 (完整版)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: system-ui, -apple-system, sans-serif; margin:0; padding:20px; background:#f4f4f9; color:#333; }
.container { max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
h2 { text-align:center; }
.button-group { display:flex; gap:10px; margin-bottom:20px; }
.searchButton { flex:1; padding:15px; font-size:16px; font-weight:bold; color:white; border:none; border-radius:5px; cursor:pointer; transition:0.2s; }
.searchButton:disabled { background:#aaa; cursor:not-allowed; }
#searchPolice { background:#007bff; }
#searchStore { background:#28a745; }
#status { text-align:center; margin:20px 0; font-style:italic; color:#6c757d; }
#results { padding:0; list-style:none; }
#results li { border-bottom:1px solid #eee; padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
#results li:last-child { border-bottom:none; }
#results a { padding:8px 12px; background:#17a2b8; color:white; text-decoration:none; border-radius:5px; white-space:nowrap; }
#results .info { flex:1; }
</style>
</head>
<body>
<div class="container">
    <h2>查找附近設施 (完整版)</h2>
    <div class="button-group">
        <button id="searchPolice" class="searchButton">找最近的警察局</button>
        <button id="searchStore" class="searchButton">找最近的便利商店</button>
    </div>
    <div id="status">請選擇要搜尋的項目。</div>
    <ul id="results"></ul>
</div>

<script>
const BACKEND_API_BASE_URL = "https://jayceon-lawlike-unallegedly.ngrok-free.dev";

async function findNearby(type) {
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const policeBtn = document.getElementById('searchPolice');
    const storeBtn = document.getElementById('searchStore');

    results.innerHTML = '';
    status.textContent = '正在取得您的位置...';
    policeBtn.disabled = true;
    storeBtn.disabled = true;

    if (!navigator.geolocation) {
        status.textContent = '瀏覽器不支援定位';
        policeBtn.disabled = false;
        storeBtn.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = +pos.coords.latitude.toFixed(6);
        const lng = +pos.coords.longitude.toFixed(6);

        status.textContent = `定位成功：${lat}, ${lng}，正在查詢...`;

        const params = new URLSearchParams({ lat, lng, type });
        let apiUrl = `${BACKEND_API_BASE_URL}/api/nearby?${params.toString()}`;
        // 轉碼 URL，避免非法字元錯誤
        apiUrl = encodeURI(apiUrl);
        console.log('最終 API URL:', apiUrl);

        try {
            const resp = await fetch(apiUrl);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            console.log('回傳資料:', data);

            if (!data || data.length === 0) {
                status.textContent = '附近沒有資料';
            } else {
                data.sort((a,b) => a.distance - b.distance);
                status.textContent = `找到 ${data.length} 個結果，距離由近到遠排序`;
                data.forEach(p => {
                    const li = document.createElement('li');
                    li.innerHTML = `<div class="info"><strong>${p.name}</strong><br>${p.address || ''}<br>距離約 ${p.distance} 公里</div>
                                    <a href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank">導航</a>`;
                    results.appendChild(li);
                });
            }
        } catch (err) {
            console.error(err);
            status.textContent = `查詢失敗：${err.message}\n📍 經緯度：${lat},${lng}`;
        } finally {
            policeBtn.disabled = false;
            storeBtn.disabled = false;
        }

    }, (err) => {
        console.error(err);
        let msg = '無法取得位置';
        if (err.code === 1) msg = '您拒絕了位置授權';
        if (err.code === 2) msg = '無法根據網路/GPS判斷位置';
        if (err.code === 3) msg = '定位超時，請確認 GPS訊號';
        status.textContent = msg;
        policeBtn.disabled = false;
        storeBtn.disabled = false;
    });
}

// LIFF 初始化
async function main() {
    try {
        await liff.init({ liffId: "2008106671-RMxabbaV" });
        if (liff.isLoggedIn()) {
            document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
            document.getElementById('searchStore').addEventListener('click', () => findNearby('store'));
        }
    } catch (err) {
        console.error('LIFF 初始化失敗', err);
        document.getElementById('status').textContent = 'LIFF 初始化失敗';
    }
}

main();
</script>
</body>
</html>
