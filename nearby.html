<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查找附近設施 (動態版)</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- CSS 樣式保持不變 --- */
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .searchButton { flex: 1; padding: 15px; font-size: 16px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color: 0.2s; }
        .searchButton:disabled { background-color: #aaa; cursor: not-allowed; }
        #searchPolice { background-color: #007bff; }
        #searchStore { background-color: #28a745; }
        #status { text-align: center; margin: 20px 0; font-style: italic; color: #6c757d; }
        #results li { list-style-type: none; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #results li:last-child { border-bottom: none; }
        #results .info { margin-right: 10px; }
        #results a { display: inline-block; padding: 8px 12px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 5px; white-space: nowrap; }
        #results { padding: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>查找附近設施 (動態版)</h2>
        <div class="button-group">
            <button id="searchPolice" class="searchButton">找最近的警察局</button>
            <button id="searchStore" class="searchButton">找最近的便利商店</button>
        </div>
        <div id="status">請選擇要搜尋的項目。</div>
        <ul id="results"></ul>
    </div>

    <script>
        // --- 【【【重大修改！！！】】】 ---
        // 不再需要寫死的資料庫了！
        // const policeStations = [...];
        // const convenienceStores = [...];

        // --- 【【【新增！！！】】】 ---
        // 這裡需要填入您後端伺服器實際運行的公開網址
        // 在本機測試時，需要用您電腦的區域網路 IP 位址
        // 例如： const BACKEND_API_BASE_URL = "http://192.168.1.100:5001"; 
        // 如果您不知道 IP，可以暫時留空，我們先用其他方式測試
        const BACKEND_API_BASE_URL = "https://jayceon-lawlike-unallegedly.ngrok-free.dev"; // 【【請注意！稍後需要修改這裡】】

        // 計算距離的函式 (不再需要在前端計算，但保留備用)
        function getDistance(lat1, lon1, lat2, lon2) { /* ... */ }

        // 主要的搜尋功能函式 (已大幅修改)
        async function findNearby(dataType) {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const policeButton = document.getElementById('searchPolice');
            const storeButton = document.getElementById('searchStore');

            policeButton.disabled = true; storeButton.disabled = true;
            statusDiv.textContent = '正在取得您的位置...';
            resultsDiv.innerHTML = '';

            // --- 1. 取得使用者 GPS 位置 (使用標準網頁定位) ---
            if (!navigator.geolocation) {
                statusDiv.textContent = '您的瀏覽器不支援定位功能。';
                policeButton.disabled = false; storeButton.disabled = false; return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => { // 【注意】這裡改成了 async 函式
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    statusDiv.textContent = '定位成功，正在向後端請求資料...';

                    // --- 2. 呼叫我們自己的後端 API ---
                    try {
// 【新】使用 URLSearchParams 來更安全地組合參數
const params = new URLSearchParams({
    lat: userLat,
    lng: userLng,
    type: dataType
});

// 組合最終的 URL 字串
const apiUrl = `${BACKEND_API_BASE_URL}/api/nearby?${params.toString()}`;

// 【重要】如果 BACKEND_API_BASE_URL 尚未設定，先提示錯誤
if (!BACKEND_API_BASE_URL) {
    throw new Error("後端 API 位址尚未設定");
}

alert("準備呼叫的 API 網址:\n" + apiUrl); // 保留 alert 方便觀察
console.log("正在呼叫後端 API:", apiUrl);

// 【新】嘗試使用 URL 物件來進行 fetch，可能更穩定
try {
    const urlObject = new URL(apiUrl); 
    const response = await fetch(urlObject); // 改用 URL 物件來 fetch
// --- 後續的 response.ok 檢查 和 await response.json() 保持不變 ---

// ... (原本 try 區塊剩餘的程式碼) ...

} catch (fetchError) {
    // 如果 fetch 本身就失敗 (例如 URL 格式錯誤)，在這裡處理
     console.error('Fetch API 呼叫失敗:', fetchError);
     throw new Error(`無法呼叫後端 API: ${fetchError.message}`); // 拋出新的錯誤，會被外層 catch 接住
}

// --- 【注意】原本的 const response = await fetch(apiUrl); 要刪掉 ---

                        // 檢查後端是否回應成功 (狀態碼 200-299)
                        if (!response.ok) {
                            // 如果後端回傳錯誤，嘗試讀取錯誤訊息
                            let errorData = { message: `後端伺服器錯誤 (HTTP ${response.status})`};
                            try { errorData = await response.json(); } catch (e) { /*忽略解析錯誤*/ }
                            throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
                        }

                        // 解析後端回傳的 JSON 結果 (最近的 5 筆地點)
                        const nearestPlaces = await response.json();
                        console.log("收到後端回應:", nearestPlaces); // 在 Console 印出結果

                        // --- 3. 將後端回傳的結果顯示在畫面上 ---
                        if (nearestPlaces && nearestPlaces.length > 0) {
                            statusDiv.textContent = `搜尋完成！以下是離您最近的${dataType === 'police' ? '警察局' : '便利商店'}：`;
                            nearestPlaces.forEach(place => {
                                const li = document.createElement('li');
                                const distanceKm = place.distance; // 後端已經算好距離了
                                const navLink = `https://www.google.com/maps?q=${place.lat},${place.lng}`;
                                li.innerHTML = `
                                    <div class="info">
                                        <strong>${place.name}</strong><br>
                                        <small>${place.address || ''}</small><br> <small>距離您約 ${distanceKm} 公里</small>
                                    </div>
                                    <a href="${navLink}" target="_blank" rel="noopener">前往導航</a>`;
                                resultsDiv.appendChild(li);
                            });
                        } else {
                            statusDiv.textContent = '在您附近未找到相關地點。';
                        }

                    } catch (error) {
                        console.error('呼叫後端 API 時發生錯誤:', error);
                        statusDiv.textContent = `查詢時發生錯誤：${error.message}`;
                    } finally {
                        policeButton.disabled = false;
                        storeButton.disabled = false;
                    }
                },
                // 定位失敗時執行的函式 (與之前相同)
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMessage = '無法取得您的位置。';
                    if (error.code === 1) errorMessage = '您拒絕了位置授權。請重設權限後再試一次。';
                    if (error.code === 2) errorMessage = '無法根據您的網路或GPS判斷位置。';
                    if (error.code === 3) errorMessage = '定位超時，請確認您的 GPS訊號良好。';
                    statusDiv.textContent = errorMessage;
                    policeButton.disabled = false; storeButton.disabled = false;
                }
            );
        }

        // LIFF 初始化 (保持不變)
        async function main() {
            try {
                // 【重要】請確認這裡的 LIFF ID 仍然是指向 nearby.html 的那個
                await liff.init({ liffId: "2008106671-RMxabbaV" }); 
                if (liff.isLoggedIn()) {
                    document.getElementById('searchPolice').addEventListener('click', () => findNearby('police'));
                    // 【注意】便利商店按鈕暫時無法使用，因為後端尚未支援 type=store
                    // 我們可以先讓它也搜尋警察局，或者先禁用它
                    document.getElementById('searchStore').addEventListener('click', () => {
                         alert("便利商店功能尚未完成，敬請期待！");
                         // 或者如果您想讓它也搜尋警察局： findNearby('police'); 
                    }); 
                    // document.getElementById('searchStore').disabled = true; // 直接禁用按鈕
                }
            } catch (err) {
                console.error('LIFF Initialization failed', err);
                document.getElementById('status').textContent = 'LIFF 初始化失敗。';
            }
        }
        main();
    </script>
</body>
</html>