<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Guardian Light｜安全熱圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background-color: #f9fafb;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 6px 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-danger { background-color: #ef4444; color: white; }
    .btn-safe { background-color: #10b981; color: white; }
    .btn-mix { background-color: #3b82f6; color: white; }
    .btn-clear { background-color: #f3f4f6; color: #111827; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="toolbar">
    <button class="btn btn-danger" id="btnDanger">🔥 危險熱圖</button>
    <button class="btn btn-safe" id="btnSafe">🟢 安全熱圖</button>
    <button class="btn btn-mix" id="btnMix">🌈 綜合安全圖</button>
    <button class="btn btn-clear" id="btnClear">❌ 清除</button>
  </div>

  <script>
    let map;
    let currentLayer = null;
    let userMarker = null;
    let userCircle = null;
    let heatmapData = [];

    async function initMap() {
      // 抓 API key
      const keyRes = await fetch('/api/config');
      const { GOOGLE_MAPS_API_KEY } = await keyRes.json();

      // 載入 Google Maps JS
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=visualization`;
      document.head.appendChild(script);
      await new Promise(resolve => script.onload = resolve);

      // 初始化地圖
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 25.0418, lng: 121.5463 },
        zoom: 13,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      // 定位使用者
      setupUserLocation();

      // 抓熱圖資料
      await loadHeatmapData();
      setupButtons();
    }

function setupUserLocation() {
  if (!navigator.geolocation) {
    console.warn("❌ 瀏覽器不支援定位");
    return;
  }

  // 加入自訂動畫
  const style = document.createElement('style');
  style.innerHTML = `
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.6); opacity: 0.3; }
      100% { transform: scale(1); opacity: 0.9; }
    }
    .my-location-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      background: white;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .my-location-btn:hover { transform: scale(1.1); }
  `;
  document.head.appendChild(style);

  // 加入「我的位置」按鈕
  const myLocBtn = document.createElement("div");
  myLocBtn.className = "my-location-btn";
  myLocBtn.innerHTML = "📍";
  document.body.appendChild(myLocBtn);
  myLocBtn.addEventListener("click", () => {
    if (window.userMarker) {
      map.panTo(window.userMarker.getPosition());
      map.setZoom(17);
    } else {
      alert("尚未取得你的定位位置！");
    }
  });

  navigator.geolocation.watchPosition(
    pos => {
      const userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };

      // 建立或更新標記
      if (!window.userMarkerEl) {
        const div = document.createElement("div");
        div.style.width = "20px";
        div.style.height = "20px";
        div.style.borderRadius = "50%";
        div.style.backgroundColor = "#3B82F6";
        div.style.border = "3px solid white";
        div.style.boxShadow = "0 0 15px rgba(59,130,246,0.7)";
        div.style.animation = "pulse 2s infinite ease-in-out";

        window.userMarkerEl = div;
        window.userMarker = new google.maps.Marker({
          position: userLoc,
          map,
          icon: {
            url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(div.outerHTML),
            anchor: new google.maps.Point(10, 10),
          },
        });

        map.setCenter(userLoc);
        map.setZoom(16);
      } else {
        window.userMarker.setPosition(userLoc);
      }

      // 更新安全範圍圈
      if (!window.userCircle) {
        window.userCircle = new google.maps.Circle({
          map,
          center: userLoc,
          radius: 80, // 可調成 50~100 公尺
          fillColor: "#3B82F6",
          fillOpacity: 0.15,
          strokeColor: "#3B82F6",
          strokeOpacity: 0.4,
          strokeWeight: 1.5,
        });
      } else {
        window.userCircle.setCenter(userLoc);
      }
    },
    err => {
      console.warn("⚠️ 定位失敗", err);
      alert("無法取得定位，請確認是否開啟 GPS 或允許權限。");
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
  );
}



    async function loadHeatmapData() {
      try {
        const res = await fetch('/api/heatmap?limit=2000');
        heatmapData = await res.json();
        console.log(`✅ 熱圖資料載入：${heatmapData.length} 筆`);
      } catch (e) {
        alert("無法載入熱圖資料：" + e.message);
      }
    }

    function setupButtons() {
      document.getElementById("btnDanger").onclick = () => showHeatmap("danger");
      document.getElementById("btnSafe").onclick = () => showHeatmap("safe");
      document.getElementById("btnMix").onclick = () => showHeatmap("mix");
      document.getElementById("btnClear").onclick = clearHeatmap;
    }

    function showHeatmap(mode) {
      clearHeatmap();
      if (!heatmapData.length) return alert("尚未載入資料！");
      let points = [];

      if (mode === "danger") {
        points = heatmapData.filter(p => p.safety < 0)
          .map(p => new google.maps.LatLng(p.lat, p.lng));
      } else if (mode === "safe") {
        points = heatmapData.filter(p => p.safety > 0)
          .map(p => new google.maps.LatLng(p.lat, p.lng));
      } else {
        points = heatmapData.map(p => ({
          location: new google.maps.LatLng(p.lat, p.lng),
          weight: p.safety
        }));
      }

      const config = {
        data: points,
        map: map,
        dissipating: true,
        radius: 20,
        opacity: 0.7,
      };

      if (mode === "danger") {
        config.gradient = [
          "rgba(255,0,0,0)",
          "rgba(255,100,100,1)",
          "rgba(255,0,0,1)"
        ];
      } else if (mode === "safe") {
        config.gradient = [
          "rgba(0,255,0,0)",
          "rgba(144,238,144,1)",
          "rgba(0,128,0,1)"
        ];
      } else {
        config.gradient = [
          "rgba(255,0,0,0)",
          "rgba(255,0,0,1)",
          "rgba(255,255,0,1)",
          "rgba(0,255,0,1)"
        ];
      }

      currentLayer = new google.maps.visualization.HeatmapLayer(config);
    }

    function clearHeatmap() {
      if (currentLayer) {
        currentLayer.setMap(null);
        currentLayer = null;
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
